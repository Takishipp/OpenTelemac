// This file is released under the 3-clause BSD license. See COPYING-BSD.
//=================================
toolbox_dir=getenv("toolbox_dir");
c = filesep();
// creation du modele
[erreur, id] = CreateMascaret();
assert_checkequal(id,1);
// importation du modele
TabNomFichier = [toolbox_dir+c+".."+c+"bin"+c+"dico.txt", ..
                 toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"data"+c+"MASCARET_1"+c+"cas"+c+"mascaret0.cas", ..
                 toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"data"+c+"MASCARET_1"+c+"cas"+c+"mascaret0.geo", ..
                 toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"data"+c+"MASCARET_1"+c+"cas"+c+"mascaret0_0.loi", ..
                 toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"data"+c+"MASCARET_1"+c+"cas"+c+"mascaret0_1.loi", ..
                 toolbox_dir+c+"mascaret0.lis", ..
                 toolbox_dir+c+"listing.damoc", ..
                 toolbox_dir+c+"mascaret0_ecr.opt"];
TypeNomFichier = ["dico","cas","geo","loi","loi","listing","damocle","res"];
impression = 0;
erreur = ImportModeleMascaret(id,TabNomFichier,TypeNomFichier,impression);
assert_checkequal(erreur,0);
// initialisation
erreur = InitEtatMascaret(id,toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"data"+c+"MASCARET_1"+c+"cas"+c+"mascaret0.lig",impression);
assert_checkequal(erreur,0);
// acces aux pas de temps de simulation
[erreur,pasTps] = GetDoubleMascaret(id,"Model.DT",0,0,0);
assert_checkequal(erreur,0);
[erreur,T0] = GetDoubleMascaret(id,"Model.InitTime",0,0,0);
assert_checkequal(erreur,0);
[erreur,TF] = GetDoubleMascaret(id,"Model.MaxCompTime",0,0,0);
assert_checkequal(erreur,0);
TF = 221.4;
// calcul
erreur = CalculMascaret(id,T0,TF,pasTps,impression);
assert_checkequal(erreur,0);
// recuperation des resultats
[erreur,nbSec,taille2,taille3] = GetTailleVarMascaret(id,"Model.X", 0);
Z = zeros(nbSec,1);
Q = zeros(nbSec,1);
for i = 1:nbSec
    [erreur,Z(i)] = GetDoubleMascaret(id,"State.Z",i,0,0);
    assert_checkequal(erreur,0);
    [erreur,Q(i)] = GetDoubleMascaret(id,"State.Q",i,0,0);
    assert_checkequal(erreur,0);
end
ResRef = read(toolbox_dir+c+".."+c+"test"+c+"Plan_Tests"+c+"Test6"+c+"ref"+c+"res1.txt",nbSec,3);
// test de la solution sur la cote
code_retour = assert_checkalmostequal(Z,ResRef(:,2),%eps,1.D-6);
assert_checktrue(code_retour);
// test de la solution sur le debit
code_retour = assert_checkalmostequal(Q,ResRef(:,3),%eps,1.D-6);
assert_checktrue(code_retour);
// destruction du modele
erreur=DeleteMascaret(id);
assert_checkequal(erreur,0);
